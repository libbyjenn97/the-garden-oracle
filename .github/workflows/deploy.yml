name: Deploy to IBM Cloud Code Engine

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

env:
  IBM_CLOUD_REGION: us-south
  CODE_ENGINE_PROJECT: garden-oracle-project
  CODE_ENGINE_APP: garden-oracle

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install IBM Cloud CLI
        run: |
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud --version
          ibmcloud config --check-version=false
          ibmcloud plugin install -f code-engine

      - name: Authenticate with IBM Cloud
        run: |
          ibmcloud login --apikey ${{ secrets.IBM_CLOUD_API_KEY }} -r ${{ env.IBM_CLOUD_REGION }}

      - name: Deploy to Code Engine with source build
        run: |
          ibmcloud ce project select --name ${{ env.CODE_ENGINE_PROJECT }}
          
          echo "Deploying application with source code build..."
          ibmcloud ce app update \
            --name ${{ env.CODE_ENGINE_APP }} \
            --build-source . \
            --build-context-dir . \
            --build-dockerfile Dockerfile \
            --env NOTION_TOKEN=${{ secrets.NOTION_TOKEN }} \
            --env NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }} \
            --cpu 0.25 \
            --memory 0.5G \
            --min-scale 0 \
            --max-scale 2 \
            --port 8080 \
            --wait

      - name: Get application URL
        run: |
          APP_URL=$(ibmcloud ce app get --name ${{ env.CODE_ENGINE_APP }} --output json | jq -r '.status.url')
          echo "ðŸš€ Application deployed successfully!"
          echo "ðŸ“± URL: ${APP_URL}"
          echo "âœ… Commit: ${{ github.sha }}"

      - name: Deployment summary
        run: |
          echo "### ðŸŒ± Garden Oracle Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—ï¸ **Build:** Code Engine source build" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "â° **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY

# Made with Bob
