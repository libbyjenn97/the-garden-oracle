name: Deploy to IBM Cloud Code Engine

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

env:
  IBM_CLOUD_REGION: au-syd
  IBM_CLOUD_RESOURCE_GROUP: itz-wxo-697d5267010cfefe9db664
  CODE_ENGINE_PROJECT: garden-oracle
  CODE_ENGINE_APP: garden-oracle

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install IBM Cloud CLI
        run: |
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud --version
          ibmcloud config --check-version=false
          ibmcloud plugin install -f code-engine

      - name: Authenticate with IBM Cloud
        run: |
          ibmcloud login --apikey ${{ secrets.IBM_CLOUD_API_KEY }} -r ${{ env.IBM_CLOUD_REGION }}
          ibmcloud target -g ${{ env.IBM_CLOUD_RESOURCE_GROUP }}

      - name: Setup Code Engine project
        run: |
          # Check if project exists, create if not
          if ! ibmcloud ce project get --name ${{ env.CODE_ENGINE_PROJECT }} &>/dev/null; then
            echo "Project doesn't exist, creating..."
            ibmcloud ce project create --name ${{ env.CODE_ENGINE_PROJECT }}
          fi
          ibmcloud ce project select --name ${{ env.CODE_ENGINE_PROJECT }}

      - name: Create registry secret
        run: |
          # Check if registry secret exists
          if ! ibmcloud ce registry get --name garden-oracle-registry-secret &>/dev/null; then
            echo "Creating registry secret..."
            ibmcloud ce registry create \
              --name garden-oracle-registry-secret \
              --server us.icr.io \
              --username iamapikey \
              --password ${{ secrets.IBM_CLOUD_API_KEY }}
          fi
          
      - name: Create or update build configuration
        run: |
          # Check if build exists
          if ! ibmcloud ce build get --name garden-oracle-build &>/dev/null; then
            echo "Creating build configuration..."
            ibmcloud ce build create \
              --name garden-oracle-build \
              --source https://github.com/${{ github.repository }} \
              --commit ${{ github.ref_name }} \
              --context-dir . \
              --dockerfile Dockerfile \
              --image us.icr.io/cr-itz-c1mx6por/garden-oracle \
              --registry-secret garden-oracle-registry-secret \
              --size small
          fi
          
      - name: Trigger build and deploy
        run: |
          echo "Submitting build run..."
          ibmcloud ce buildrun submit --build garden-oracle-build --wait
          
          # Check if app exists
          if ibmcloud ce app get --name ${{ env.CODE_ENGINE_APP }} --output json 2>/dev/null | jq -e '.name' > /dev/null; then
            echo "Updating existing application..."
            ibmcloud ce app update \
              --name ${{ env.CODE_ENGINE_APP }} \
              --image us.icr.io/cr-itz-c1mx6por/garden-oracle:latest \
              --env NOTION_TOKEN=${{ secrets.NOTION_TOKEN }} \
              --env NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }}
          else
            echo "Creating new application..."
            ibmcloud ce app create \
              --name ${{ env.CODE_ENGINE_APP }} \
              --image us.icr.io/cr-itz-c1mx6por/garden-oracle:latest \
              --registry-secret garden-oracle-registry-secret \
              --env NOTION_TOKEN=${{ secrets.NOTION_TOKEN }} \
              --env NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }} \
              --cpu 0.25 \
              --memory 0.5G \
              --min-scale 0 \
              --max-scale 2 \
              --port 8080
          fi
          
          echo "Deploying application with source code build..."
          ibmcloud ce app update \
            --name ${{ env.CODE_ENGINE_APP }} \
            --build-source . \
            --build-context-dir . \
            --build-dockerfile Dockerfile \
            --env NOTION_TOKEN=${{ secrets.NOTION_TOKEN }} \
            --env NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }} \
            --cpu 0.25 \
            --memory 0.5G \
            --min-scale 0 \
            --max-scale 2 \
            --port 8080 \
            --wait

      - name: Get application URL
        run: |
          APP_URL=$(ibmcloud ce app get --name ${{ env.CODE_ENGINE_APP }} --output json | jq -r '.status.url')
          echo "ðŸš€ Application deployed successfully!"
          echo "ðŸ“± URL: ${APP_URL}"
          echo "âœ… Commit: ${{ github.sha }}"

      - name: Deployment summary
        run: |
          echo "### ðŸŒ± Garden Oracle Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—ï¸ **Build:** Code Engine source build" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "â° **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY

# Made with Bob
